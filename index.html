<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è™•æ–¹ç®‹å¿«å‚³ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; padding-bottom: 50px; }
    .container { max-width: 600px; padding-top: 20px; }
    .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    /* ä¸Šå‚³å€ */
    .preview-box {
      width: 100%; height: 220px; background: #e9ecef; border: 2px dashed #ced4da;
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      overflow: hidden; cursor: pointer; position: relative;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder-text { color: #6c757d; text-align: center; font-size: 0.9rem; }
    
    /* æ­·å²ç´€éŒ„å€ */
    .history-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
    .history-item:last-child { border-bottom: none; }
    .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-ready { background: #d1e7dd; color: #0f5132; }
    .history-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; background: #eee; margin-right: 10px; }

    /* Loading */
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-success" role="status"></div>
  <p class="mt-3 text-secondary fw-bold" id="loadingText">ç³»çµ±é€£ç·šä¸­...</p>
</div>

<div class="container">
  
  <div class="card p-4">
    <h4 class="text-center fw-bold text-success mb-3"><i class="bi bi-camera"></i> è™•æ–¹ç®‹å¿«å‚³</h4>
    
    <div class="mb-3">
      <div class="preview-box" onclick="document.getElementById('fileInput').click()">
        <div class="placeholder-text" id="placeholder">
          <span style="font-size: 2rem;">ğŸ“·</span><br>é»æ“Šæ‹æ” / é¸æ“‡ç…§ç‰‡
        </div>
        <img id="previewImg">
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(this)">
    </div>

    <div class="mb-3">
      <label class="form-label small fw-bold text-muted">é ˜è—¥äººå§“å</label>
      <input type="text" class="form-control" id="uName">
    </div>
    <div class="mb-4">
      <label class="form-label small fw-bold text-muted">è¯çµ¡é›»è©±</label>
      <input type="tel" class="form-control" id="uPhone">
    </div>

    <button class="btn btn-success w-100 py-2 fw-bold" onclick="submitData()">ç¢ºèªé€å‡º</button>
  </div>

  <div class="card p-3" id="historyCard" style="display: none;">
    <h6 class="fw-bold text-muted mb-3">ğŸ“‹ æœ€è¿‘ä¸Šå‚³ç´€éŒ„</h6>
    <div id="historyList">
      </div>
  </div>

</div>

<script>
  // ==========================================
  // âœ… å·²å¡«å…¥æ‚¨çš„è³‡æ–™
  // ==========================================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyUXCejmkI52ZJVUN1K1t1j2ZvfdZMCgHsgB79okITgzn7to2sfte43R5I0GOQnFp1opQ/exec";
  const LIFF_ID = "2008912977-DuJTm5u1";
  // ==========================================

  let lineUserId = "";
  let base64Image = "";
  let fileName = "";

  window.onload = function() {
    initLiff();
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          lineUserId = profile.userId;
          document.getElementById('uName').value = profile.displayName;
          document.getElementById('loading').style.display = 'none';
          
          // ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹åˆ»æŠ“å–æ­·å²ç´€éŒ„
          loadHistory();
        });
      }
    }).catch(err => {
      // é›–ç„¶ LIFF å¤±æ•—ï¼Œä½†é‚„æ˜¯è®“ä½¿ç”¨è€…å¯ä»¥ç”¨åŸºæœ¬åŠŸèƒ½
      console.error("LIFF Init Error:", err);
      document.getElementById('loading').style.display = 'none';
      // alert("LIFF å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID è¨­å®š");
    });
  }

  // è®€å–æ­·å²ç´€éŒ„
  function loadHistory() {
    // ä½¿ç”¨ text/plain é¿å… CORS é æª¢
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify({ action: "history", lineUserId: lineUserId })
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'success' && data.history && data.history.length > 0) {
        renderHistory(data.history);
      }
    })
    .catch(e => console.log("History error:", e));
  }

  function renderHistory(list) {
    const container = document.getElementById('historyList');
    container.innerHTML = "";
    list.forEach(item => {
      let badgeClass = item.status === 'å¯é ˜è—¥' ? 'status-ready' : 'status-pending';
      let html = `
        <div class="history-item">
          <img src="${item.img}" class="history-thumb" onerror="this.src='https://placehold.co/50?text=Rx'">
          <div style="flex-grow: 1;">
            <div class="small fw-bold">${item.date}</div>
            <div class="status-badge ${badgeClass} d-inline-block">${item.status}</div>
          </div>
        </div>`;
      container.innerHTML += html;
    });
    document.getElementById('historyCard').style.display = 'block';
  }

  function handleFile(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        base64Image = e.target.result;
        document.getElementById('previewImg').src = base64Image;
        document.getElementById('previewImg').style.display = 'block';
        document.getElementById('placeholder').style.display = 'none';
      }
      reader.readAsDataURL(file);
    }
  }

  function submitData() {
    const name = document.getElementById('uName').value;
    const phone = document.getElementById('uPhone').value;

    if (!base64Image) return alert("âš ï¸ è«‹æ‹æ”è™•æ–¹ç®‹ï¼");
    if (!name || !phone) return alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingText').innerText = "ä¸Šå‚³ä¸­...";

    const payload = {
      action: "upload",
      name: name,
      phone: phone,
      notify: "LINEé€šçŸ¥",
      fileData: base64Image,
      fileName: fileName,
      lineUserId: lineUserId,
      dept: "å‰å°ä¸Šå‚³"
    };

    // ğŸ”¥ é—œéµä¿®æ­£ï¼šç›´æ¥é€å‡ºï¼Œä¸åŠ  headersï¼Œé¿é–‹ CORS
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading').style.display = 'none';
      if(response.status === 'success') {
        alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
        location.reload(); // é‡æ•´é é¢ä»¥æ›´æ–°ç´€éŒ„
      } else {
        alert("âŒ å¤±æ•—ï¼š" + response.message);
      }
    })
    .catch(error => {
      document.getElementById('loading').style.display = 'none';
      // é€™è£¡å¦‚æœå‡ºç¾ SyntaxError ä»¥å¤–çš„éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œ
      // ä½†å¦‚æœæ˜¯ GAS é‡å®šå‘å•é¡Œï¼Œé€šå¸¸ä»£è¡¨è³‡æ–™å·²é€å‡º
      alert("ä¸Šå‚³å®Œæˆ (è«‹ç¢ºèªä¸‹æ–¹æ­·å²ç´€éŒ„)"); 
      setTimeout(() => location.reload(), 2000);
    });
  }
</script>

</body>
</html>
