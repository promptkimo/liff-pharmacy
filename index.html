<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è™•æ–¹ç®‹å¿«å‚³</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
    .card { border-radius: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn-login { background-color: #06C755; color: white; width: 100%; font-weight: bold; border-radius: 50px; padding: 10px; }
    .hidden { display: none !important; }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; align-items:center; justify-content:center; }
  </style>
</head>
<body>

<div id="loadingOverlay" class="hidden">
  <div class="spinner-border text-primary" role="status"></div>
</div>

<div class="container" style="max-width: 500px;">
  <div class="text-center mb-4"><h3>ğŸ’Š è™•æ–¹ç®‹å¿«å‚³</h3></div>

  <div id="loginSection" class="text-center mb-3 hidden">
    <button onclick="liff.login()" class="btn btn-login">ğŸ’¬ ç™»å…¥ LINE ä»¥è‡ªå‹•å¸¶å…¥è³‡æ–™</button>
  </div>

  <div id="welcomeSection" class="alert alert-success text-center py-2 hidden">
    ğŸ‘‹ å—¨ï¼Œ<span id="userName">ç”¨æˆ¶</span>
  </div>

  <div class="card p-3">
    <form id="uploadForm">
      <div class="mb-3"><label>å§“å</label><input type="text" class="form-control" id="name" required></div>
      <div class="mb-3"><label>é›»è©±</label><input type="tel" class="form-control" id="phone" required></div>
      <div class="mb-3"><label>èº«åˆ†è­‰æœ«å››ç¢¼</label><input type="number" class="form-control" id="idCheck" required></div>
      <div class="mb-3">
        <label>é€šçŸ¥æ–¹å¼</label>
        <select class="form-select" id="notify"><option>LINEé€šçŸ¥</option><option>é›»è©±é€šçŸ¥</option></select>
      </div>
      <div class="mb-3"><label>ç…§ç‰‡</label><input type="file" class="form-control" id="fileInput" accept="image/*" required></div>
      <button type="submit" class="btn btn-primary w-100" id="submitBtn">ç¢ºèªé€å‡º</button>
    </form>
    
    <hr>
    <button class="btn btn-outline-secondary btn-sm w-100" onclick="doSearch()">æŸ¥è©¢æ­·å²ç´€éŒ„</button>
    <div id="historyBox" class="mt-3 text-center small text-muted"></div>
  </div>
</div>

<script>
  // ğŸ”¥ è¨­å®šå€ ğŸ”¥
  const MY_LIFF_ID = '2008912977-DuJTm5u1';
  // ğŸ‘‡ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ å‰›å‰›è¤‡è£½çš„ GAS ç¶²å€ ğŸ‘‡
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyUXCejmkI52ZJVUN1K1t1j2ZvfdZMCgHsgB79okITgzn7to2sfte43R5I0GOQnFp1opQ/exec'; 

  let userLineId = '';

  window.onload = function() {
    // è®€å–æœ¬åœ°è¨˜æ†¶
    if(localStorage.getItem('uPhone')) document.getElementById('phone').value = localStorage.getItem('uPhone');
    if(localStorage.getItem('uId')) document.getElementById('idCheck').value = localStorage.getItem('uId');

    // åˆå§‹åŒ– LIFF
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(profile => {
          userLineId = profile.userId;
          document.getElementById('userName').innerText = profile.displayName;
          document.getElementById('welcomeSection').classList.remove('hidden');
          autoSearch();
        });
      } else {
        document.getElementById('loginSection').classList.remove('hidden');
      }
    });
  };

  // çµ±ä¸€ç™¼é€è«‹æ±‚çµ¦ GAS
  function sendToGAS(payload) {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    
    // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
    // mode: 'no-cors' æ˜¯ GAS çš„ç‰¹æ®Šé™åˆ¶ï¼Œä½†é€™æœƒå°è‡´æ‹¿ä¸åˆ°å›å‚³å€¼
    // æ‰€ä»¥æˆ‘å€‘ç”¨æ¨™æº– corsï¼Œä½† GAS å¿…é ˆå›å‚³æ­£ç¢ºçš„ JSON
    return fetch(GAS_API_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .finally(() => {
      document.getElementById('loadingOverlay').classList.add('hidden');
    });
  }

  // ä¸Šå‚³
  document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const file = document.getElementById('fileInput').files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const payload = {
        action: 'upload',
        fileData: e.target.result,
        fileName: file.name,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        idCheck: document.getElementById('idCheck').value,
        notify: document.getElementById('notify').value,
        lineUserId: userLineId
      };
      
      // è¨˜æ†¶
      localStorage.setItem('uPhone', payload.phone);
      localStorage.setItem('uId', payload.idCheck);

      sendToGAS(payload).then(res => {
        if(res.status === 'success') {
          alert(res.message);
          document.getElementById('uploadForm').reset();
          if(userLineId) autoSearch();
        } else {
          alert('ä¸Šå‚³å¤±æ•—: ' + res.message);
        }
      });
    };
    reader.readAsDataURL(file);
  });

  // æŸ¥è©¢
  function doSearch() {
    const phone = document.getElementById('phone').value;
    const idCheck = document.getElementById('idCheck').value;
    if(!phone || !idCheck) return alert('è«‹è¼¸å…¥é›»è©±èˆ‡èº«åˆ†è­‰');
    
    sendToGAS({ action: 'search', phone: phone, idCheck: idCheck }).then(renderHistory);
  }

  function autoSearch() {
    sendToGAS({ action: 'search', userId: userLineId }).then(renderHistory);
  }

  function renderHistory(res) {
    const box = document.getElementById('historyBox');
    if(!res.history || res.history.length === 0) {
      box.innerText = 'å°šç„¡ç´€éŒ„';
      return;
    }
    let html = '';
    res.history.forEach(h => {
      html += `<div class="border-bottom p-2 text-start">
        <strong>${h.date}</strong> - <span class="badge bg-info text-dark">${h.status}</span>
      </div>`;
    });
    box.innerHTML = html;
  }
</script>

</body>
</html>
