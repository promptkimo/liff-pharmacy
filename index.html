<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è™•æ–¹ç®‹å¿«å‚³ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .container { max-width: 600px; padding-top: 20px; }
    .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-upload { width: 100%; padding: 12px; font-weight: bold; font-size: 1.1rem; }
    
    /* é è¦½å€å¡Šæ¨£å¼ */
    .preview-box {
      width: 100%; height: 250px;
      background: #e9ecef; border: 2px dashed #ced4da; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; cursor: pointer; position: relative;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder-text { color: #6c757d; text-align: center; }
    
    /* Loading é®ç½© */
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-success" role="status"></div>
  <p class="mt-3 fw-bold text-secondary" id="loadingText">ç³»çµ±å•Ÿå‹•ä¸­...</p>
</div>

<div class="container">
  <div class="card p-4">
    <h3 class="text-center fw-bold text-success mb-3">è™•æ–¹ç®‹å¿«å‚³</h3>
    
    <div class="alert alert-success d-flex align-items-center" role="alert" id="loginInfo" style="display:none !important;">
      <img id="userThumb" src="" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
      <div>
        <small>æ­¡è¿æ‚¨ï¼Œ</small><br>
        <strong id="displayName">è¼‰å…¥ä¸­...</strong>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">1. æ‹æ”/ä¸Šå‚³è™•æ–¹ç®‹</label>
      <div class="preview-box" onclick="document.getElementById('fileInput').click()">
        <div class="placeholder-text" id="placeholder">
          <span style="font-size: 2rem;">ğŸ“·</span><br>é»æ“Šæ‹æ”
        </div>
        <img id="previewImg">
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(this)">
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">2. é ˜è—¥äººå§“å</label>
      <input type="text" class="form-control" id="uName" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold">3. è¯çµ¡é›»è©±</label>
      <input type="tel" class="form-control" id="uPhone" placeholder="09xx-xxx-xxx">
    </div>

    <button class="btn btn-success btn-upload" onclick="submitData()">ç¢ºèªé€å‡º</button>
  </div>
  <p class="text-center text-muted mt-3 small">è—¥å¸«ç¢ºèªå¾Œå°‡é€é LINE é€šçŸ¥æ‚¨</p>
</div>

<script>
  // ==========================================
  // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„è³‡æ–™ âš ï¸
  // ==========================================
  
  // 1. å‰›å‰›åœ¨ GAS è¤‡è£½çš„ç¶²å€ (çµå°¾æ˜¯ /exec)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyUXCejmkI52ZJVUN1K1t1j2ZvfdZMCgHsgB79okITgzn7to2sfte43R5I0GOQnFp1opQ/exec"; 
  
  // 2. å‰›å‰›åœ¨ LINE Developers è¤‡è£½çš„ LIFF ID
  const LIFF_ID = "2008912977-DuJTm5u1"; 

  // ==========================================

  let lineUserId = "";
  let base64Image = "";
  let fileName = "";

  // ç¶²é è¼‰å…¥å¾Œåˆå§‹åŒ– LIFF
  window.onload = function() {
    initializeLiff();
  };

  function initializeLiff() {
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        if (!liff.isLoggedIn()) {
          liff.login(); // æ²’ç™»å…¥å°±å¼·åˆ¶ç™»å…¥
        } else {
          // å·²ç™»å…¥ï¼ŒæŠ“å–è³‡æ–™
          getProfile();
        }
      })
      .catch((err) => {
        console.error('LIFF Init Error', err);
        document.getElementById('loading').style.display = 'none';
        alert("LINE ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚");
      });
  }

  function getProfile() {
    liff.getProfile()
      .then(profile => {
        lineUserId = profile.userId;
        const name = profile.displayName;
        const pictureUrl = profile.pictureUrl;
        
        // é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
        document.getElementById('displayName').innerText = name;
        document.getElementById('uName').value = name; // è‡ªå‹•å¸¶å…¥å§“å
        if(pictureUrl) document.getElementById('userThumb').src = pictureUrl;
        
        document.getElementById('loginInfo').style.display = 'flex';
        document.getElementById('loading').style.display = 'none'; // é—œé–‰ Loading
      })
      .catch(err => {
        console.error('Profile Error', err);
        document.getElementById('loading').style.display = 'none';
      });
  }

  // è™•ç†åœ–ç‰‡é¸æ“‡
  function handleFile(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName = file.name;
      
      // å£“ç¸®åœ–ç‰‡ä¸¦è½‰ Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // ç°¡å–®å£“ç¸®ï¼šå¯¬åº¦é™åˆ¶åœ¨ 1000px
          const maxWidth = 1000;
          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // è½‰æˆ Base64 (JPEG, å“è³ª 0.7)
          base64Image = canvas.toDataURL('image/jpeg', 0.7);
          
          // é¡¯ç¤ºé è¦½
          document.getElementById('previewImg').src = base64Image;
          document.getElementById('previewImg').style.display = 'block';
          document.getElementById('placeholder').style.display = 'none';
        }
      }
      reader.readAsDataURL(file);
    }
  }

  // é€å‡ºè³‡æ–™åˆ° GAS
  function submitData() {
    const name = document.getElementById('uName').value;
    const phone = document.getElementById('uPhone').value;

    if (!base64Image) return alert("âš ï¸ è«‹æ‹æ”è™•æ–¹ç®‹ï¼");
    if (!name) return alert("âš ï¸ è«‹è¼¸å…¥å§“åï¼");
    if (!phone) return alert("âš ï¸ è«‹è¼¸å…¥é›»è©±ï¼");

    // é¡¯ç¤ºä¸Šå‚³ä¸­
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingText').innerText = "æ­£åœ¨ä¸Šå‚³è™•æ–¹ç®‹...";

    // æº–å‚™è³‡æ–™
    const payload = {
      action: "upload",
      name: name,
      phone: phone,
      notify: "LINEé€šçŸ¥", // å¼·åˆ¶è¨­å®šç‚º LINE é€šçŸ¥
      fileData: base64Image,
      fileName: fileName,
      lineUserId: lineUserId, // é€™è£¡æœƒæŠŠ LIFF æŠ“åˆ°çš„ ID å‚³çµ¦å¾Œç«¯
      dept: "Lineä¸Šå‚³"
    };

    // ä½¿ç”¨ fetch ç™¼é€ (no-cors æ¨¡å¼é¿å…è·¨åŸŸéŒ¯èª¤ï¼Œä½†ç„¡æ³•è®€å–å›å‚³å€¼)
    // æ”¹ç”¨ text/plain ç¹éè¤‡é›œè«‹æ±‚
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading').style.display = 'none';
      if(response.status === 'success') {
        alert("âœ… ä¸Šå‚³æˆåŠŸï¼\nè—¥å¸«æœƒç›¡å¿«è™•ç†ã€‚");
        liff.closeWindow(); // ä¸Šå‚³å®Œè‡ªå‹•é—œé–‰è¦–çª—
      } else {
        alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + response.message);
      }
    })
    .catch(error => {
      document.getElementById('loading').style.display = 'none';
      // é€™è£¡å¦‚æœå‡ºç¾éŒ¯èª¤ï¼Œé€šå¸¸æ˜¯å› ç‚º GAS é‡å®šå‘å•é¡Œï¼Œä½†è³‡æ–™é€šå¸¸å·²é€é”
      // æˆ‘å€‘æª¢æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰æˆåŠŸ
      alert("ä¸Šå‚³ç¨‹åºå®Œæˆï¼Œè«‹ç¢ºèª LINE æ˜¯å¦æ”¶åˆ°é€šçŸ¥ã€‚");
      console.error(error);
    });
  }
</script>

</body>
</html>
