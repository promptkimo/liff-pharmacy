<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è™•æ–¹ç®‹å¿«å‚³</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; padding-bottom: 60px; }
    .container { max-width: 600px; padding-top: 15px; }
    .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    /* ä½¿ç”¨è€…è³‡è¨Šå¡ */
    .user-card { background: white; padding: 15px; display: flex; align-items: center; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #28a745; }
    
    /* ä¸Šå‚³å€ */
    .preview-box {
      width: 100%; height: 200px; background: #e9ecef; border: 2px dashed #ced4da;
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      overflow: hidden; cursor: pointer; position: relative; margin-bottom: 15px;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder-text { color: #6c757d; text-align: center; font-size: 0.9rem; }
    
    /* æ­·å²ç´€éŒ„ */
    .history-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; background: white; }
    .history-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .history-item:last-child { border-bottom: none; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
    .status-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
    .status-pending { background: #ffeeba; color: #856404; } /* å¾…è™•ç† */
    .status-ready { background: #d1e7dd; color: #0f5132; }   /* å¯é ˜è—¥ */
    .history-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; background: #eee; margin-right: 15px; border: 1px solid #ddd; }

    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-success" role="status"></div>
  <p class="mt-3 text-secondary fw-bold" id="loadingText">ç³»çµ±é€£ç·šä¸­...</p>
</div>

<div class="container">
  
  <div class="user-card" id="userInfo" style="display: none;">
    <img id="userThumb" src="https://placehold.co/50?text=U" class="user-avatar">
    <div>
      <div class="small text-muted">æ­¡è¿ä½¿ç”¨</div>
      <div class="fw-bold fs-5" id="userNameDisplay">è¨ªå®¢</div>
    </div>
  </div>

  <div class="card p-4">
    <h5 class="fw-bold text-success mb-3"><i class="bi bi-camera"></i> ä¸Šå‚³è™•æ–¹ç®‹</h5>
    
    <div class="preview-box" onclick="document.getElementById('fileInput').click()">
      <div class="placeholder-text" id="placeholder">
        <span style="font-size: 2rem;">ğŸ“·</span><br>é»æ­¤æ‹ç…§ / é¸ç…§ç‰‡
      </div>
      <img id="previewImg">
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(this)">

    <div class="mb-3">
      <label class="form-label small fw-bold">é ˜è—¥äººå§“å</label>
      <input type="text" class="form-control" id="uName">
    </div>
    <div class="mb-3">
      <label class="form-label small fw-bold">è¯çµ¡é›»è©±</label>
      <input type="tel" class="form-control" id="uPhone" placeholder="09xx-xxx-xxx">
    </div>
    
    <div class="mb-4">
      <label class="form-label small fw-bold">ç§‘åˆ¥ (é¸å¡«)</label>
      <input type="text" class="form-control" id="uDept" placeholder="ä¾‹å¦‚ï¼šç‰™ç§‘ã€å…§ç§‘...">
    </div>

    <button class="btn btn-success w-100 fw-bold py-2" onclick="submitData()">ç¢ºèªé€å‡º</button>
  </div>

  <h6 class="fw-bold text-muted ms-2 mb-2"><i class="bi bi-clock-history"></i> ä¸Šå‚³ç´€éŒ„ (æœ€è¿‘5ç­†)</h6>
  <div id="historyList">
    <div class="text-center py-4 text-muted small">è¼‰å…¥ä¸­...</div>
  </div>

</div>

<script>
  // ==========================================
  // âš ï¸ è³‡æ–™å€ (è«‹ç¢ºèªæ˜¯å¦æ­£ç¢º)
  // ==========================================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyUXCejmkI52ZJVUN1K1t1j2ZvfdZMCgHsgB79okITgzn7to2sfte43R5I0GOQnFp1opQ/exec"; 
  const LIFF_ID = "2008912977-DuJTm5u1"; 
  // ==========================================

  let lineUserId = "";
  let base64Image = "";
  let fileName = "";

  window.onload = function() {
    initLiff();
  };

  function initLiff() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login(); 
      } else {
        liff.getProfile().then(profile => {
          lineUserId = profile.userId;
          const name = profile.displayName;
          const pic = profile.pictureUrl;

          document.getElementById('userNameDisplay').innerText = name;
          document.getElementById('uName').value = name;
          if(pic) document.getElementById('userThumb').src = pic;
          document.getElementById('userInfo').style.display = 'flex';
          
          document.getElementById('loading').style.display = 'none';
          
          loadHistory();
        });
      }
    }).catch(err => {
      // alert("LIFF éŒ¯èª¤ï¼š" + err); // æš«æ™‚é—œé–‰éŒ¯èª¤æç¤ºä»¥å…å¹²æ“¾
      document.getElementById('loading').style.display = 'none';
    });
  }

  function loadHistory() {
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify({ action: "history", lineUserId: lineUserId })
    })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('historyList');
      container.innerHTML = "";

      if(data.status === 'success' && data.history.length > 0) {
        data.history.forEach(item => {
          let badgeClass = item.status === 'å¯é ˜è—¥' ? 'status-ready' : 'status-pending';
          let html = `
            <div class="history-item">
              <img src="${item.img}" class="history-thumb">
              <div style="flex-grow:1;">
                <div class="d-flex justify-content-between">
                  <span class="fw-bold text-dark">${item.dept || 'ä¸€èˆ¬'}</span>
                  <span class="status-badge ${badgeClass}">${item.status}</span>
                </div>
                <div class="small text-muted mt-1">${item.date}</div>
              </div>
            </div>`;
          container.innerHTML += html;
        });
      } else {
        container.innerHTML = `<div class="text-center py-3 text-muted small">å°šç„¡ä¸Šå‚³ç´€éŒ„</div>`;
      }
    })
    .catch(e => console.log("History error:", e));
  }

  function handleFile(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if(w > 800) { h *= 800/w; w = 800; }
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          base64Image = canvas.toDataURL('image/jpeg', 0.7);
          document.getElementById('previewImg').src = base64Image;
          document.getElementById('previewImg').style.display = 'block';
          document.getElementById('placeholder').style.display = 'none';
        }
      }
      reader.readAsDataURL(file);
    }
  }

  function submitData() {
    const name = document.getElementById('uName').value;
    const phone = document.getElementById('uPhone').value;
    const dept = document.getElementById('uDept').value; // å–å¾—æ‰‹å‹•è¼¸å…¥çš„ç§‘åˆ¥

    if (!base64Image) return alert("âš ï¸ è«‹æ‹æ”è™•æ–¹ç®‹ï¼");
    if (!name || !phone) return alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingText').innerText = "è³‡æ–™ä¸Šå‚³ä¸­...";

    const payload = {
      action: "upload",
      name: name,
      phone: phone,
      dept: dept,
      notify: "LINEé€šçŸ¥",
      fileData: base64Image,
      fileName: fileName,
      lineUserId: lineUserId
    };

    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading').style.display = 'none';
      if(response.status === 'success') {
        alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
        location.reload();
      } else {
        alert("âŒ å¤±æ•—ï¼š" + response.message);
      }
    })
    .catch(error => {
      document.getElementById('loading').style.display = 'none';
      alert("ä¸Šå‚³å®Œæˆï¼Œè«‹ç¢ºèªä¸‹æ–¹ç´€éŒ„ã€‚");
      setTimeout(() => location.reload(), 2000);
    });
  }
</script>

</body>
</html>
