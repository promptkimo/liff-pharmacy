<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è—¥å±€æœå‹™ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; padding-bottom: 60px; }
    .container { max-width: 600px; padding-top: 15px; }
    .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    .user-card { background: white; padding: 15px; display: flex; align-items: center; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #28a745; }
    
    .preview-box {
      width: 100%; height: 200px; background: #e9ecef; border: 2px dashed #ced4da;
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      overflow: hidden; cursor: pointer; position: relative; margin-bottom: 15px;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder-text { color: #6c757d; text-align: center; font-size: 0.9rem; }
    
    .hidden-mode { display: none !important; } /* éš±è—æ¨¡å¼ */

    .history-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; background: white; }
    .history-item:last-child { border-bottom: none; }
    .status-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
    .status-pending { background: #ffeeba; color: #856404; }
    .status-ready { background: #d1e7dd; color: #0f5132; }
    .history-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; background: #eee; margin-right: 15px; border: 1px solid #ddd; }

    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-success" role="status"></div>
  <p class="mt-3 text-secondary fw-bold" id="loadingText">ç³»çµ±é€£ç·šä¸­...</p>
</div>

<div class="container">
  
  <div class="user-card" id="userInfo" style="display: none;">
    <img id="userThumb" src="https://placehold.co/50?text=U" class="user-avatar">
    <div>
      <div class="small text-muted">æ­¡è¿ä½¿ç”¨</div>
      <div class="fw-bold fs-5" id="userNameDisplay">è¨ªå®¢</div>
    </div>
  </div>

  <div class="card p-4">
    <h5 class="fw-bold text-success mb-3" id="formTitle"><i class="bi bi-camera"></i> ä¸Šå‚³è™•æ–¹ç®‹</h5>
    
    <div id="cameraSection">
        <div class="preview-box" onclick="document.getElementById('fileInput').click()">
        <div class="placeholder-text" id="placeholder">
            <span style="font-size: 2rem;">ğŸ“·</span><br>é»æ­¤æ‹ç…§ / é¸ç…§ç‰‡
        </div>
        <img id="previewImg">
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(this)">
    </div>

    <div class="mb-3">
      <label class="form-label small fw-bold">é ˜è—¥äººå§“å (ç—…äºº)</label>
      <input type="text" class="form-control" id="uName">
    </div>
    
    <div class="mb-3">
      <label class="form-label small fw-bold">è¯çµ¡é›»è©±</label>
      <input type="tel" class="form-control" id="uPhone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
    </div>
    
    <div class="mb-3">
      <label class="form-label small fw-bold">ç§‘åˆ¥ (é¸å¡«)</label>
      <input type="text" class="form-control" id="uDept" placeholder="ä¾‹å¦‚ï¼šç‰™ç§‘ã€å…§ç§‘...">
    </div>

    <div class="mb-4">
      <label class="form-label small fw-bold">å¸Œæœ›é€šçŸ¥æ–¹å¼</label>
      <select class="form-select" id="uNotify">
        <option value="LINEé€šçŸ¥" selected>LINE é€šçŸ¥ (æ¨è–¦)</option>
        <option value="é›»è©±é€šçŸ¥">é›»è©±é€šçŸ¥</option>
      </select>
    </div>

    <button class="btn btn-success w-100 fw-bold py-2" onclick="submitData()">ç¢ºèªé€å‡º</button>
  </div>

  <div id="historySection">
      <h6 class="fw-bold text-muted ms-2 mb-2"><i class="bi bi-clock-history"></i> ä¸Šå‚³ç´€éŒ„ (æœ€è¿‘5ç­†)</h6>
      <div id="historyList">
        <div class="text-center py-4 text-muted small">è¼‰å…¥ä¸­...</div>
      </div>
  </div>

</div>

<script>
  // ==========================================
  // âš ï¸ æ‚¨çš„è¨­å®š
  // ==========================================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyUXCejmkI52ZJVUN1K1t1j2ZvfdZMCgHsgB79okITgzn7to2sfte43R5I0GOQnFp1opQ/exec"; 
  const LIFF_ID = "2008912977-DuJTm5u1"; 
  // ==========================================

  let lineUserId = "";
  let lineDisplayName = "";
  let base64Image = "";
  let fileName = "";
  
  // ğŸ”¥ åµæ¸¬ç¶²å€åƒæ•¸ï¼šæ˜¯å¦ç‚ºç¾å ´ç™»è¨˜æ¨¡å¼
  const urlParams = new URLSearchParams(window.location.search);
  const isRegisterMode = urlParams.get('mode') === 'register';

  window.onload = function() {
    initInterface(); // åˆå§‹åŒ–ä»‹é¢
    initLiff();
  };

  function initInterface() {
    if (isRegisterMode) {
      // ç¾å ´ç™»è¨˜æ¨¡å¼ï¼šéš±è—æ‹ç…§ã€ä¿®æ”¹æ¨™é¡Œã€éš±è—æ­·å²
      document.getElementById('cameraSection').classList.add('hidden-mode');
      document.getElementById('historySection').classList.add('hidden-mode');
      document.getElementById('formTitle').innerHTML = '<i class="bi bi-person-check-fill"></i> ç¾å ´é ˜è—¥ç™»è¨˜';
    }
  }

  function initLiff() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login(); 
      } else {
        liff.getProfile().then(profile => {
          lineUserId = profile.userId;
          lineDisplayName = profile.displayName;
          const pic = profile.pictureUrl;

          document.getElementById('userNameDisplay').innerText = lineDisplayName;
          document.getElementById('uName').value = lineDisplayName; 
          if(pic) document.getElementById('userThumb').src = pic;
          document.getElementById('userInfo').style.display = 'flex';
          document.getElementById('loading').style.display = 'none';
          
          if(!isRegisterMode) loadHistory(); // åªæœ‰ä¸€èˆ¬æ¨¡å¼æ‰è®€æ­·å²
        });
      }
    }).catch(err => {
      document.getElementById('loading').style.display = 'none';
    });
  }

  function loadHistory() {
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify({ action: "history", lineUserId: lineUserId })
    })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('historyList');
      container.innerHTML = "";
      if(data.status === 'success' && data.history.length > 0) {
        data.history.forEach(item => {
          let badgeClass = item.status === 'å¯é ˜è—¥' ? 'status-ready' : 'status-pending';
          let html = `
            <div class="history-item">
              <img src="${item.img}" class="history-thumb" onerror="this.src='https://placehold.co/60?text=Rx'">
              <div style="flex-grow:1;">
                <div class="d-flex justify-content-between">
                  <span class="fw-bold text-dark">${item.dept || 'ä¸€èˆ¬'}</span>
                  <span class="status-badge ${badgeClass}">${item.status}</span>
                </div>
                <div class="small text-muted mt-1">${item.date}</div>
              </div>
            </div>`;
          container.innerHTML += html;
        });
      } else {
        container.innerHTML = `<div class="text-center py-3 text-muted small">å°šç„¡ä¸Šå‚³ç´€éŒ„</div>`;
      }
    })
    .catch(e => console.log("History error:", e));
  }

  function handleFile(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      fileName = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if(w > 800) { h *= 800/w; w = 800; }
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          base64Image = canvas.toDataURL('image/jpeg', 0.7);
          document.getElementById('previewImg').src = base64Image;
          document.getElementById('previewImg').style.display = 'block';
          document.getElementById('placeholder').style.display = 'none';
        }
      }
      reader.readAsDataURL(file);
    }
  }

  function submitData() {
    const name = document.getElementById('uName').value;
    const phone = document.getElementById('uPhone').value;
    const dept = document.getElementById('uDept').value;
    const notify = document.getElementById('uNotify').value;

    // ğŸ”¥ æª¢æŸ¥ï¼šå¦‚æœä¸æ˜¯ç¾å ´ç™»è¨˜æ¨¡å¼ï¼Œæ‰å¼·åˆ¶è¦æœ‰åœ–ç‰‡
    if (!isRegisterMode && !base64Image) return alert("âš ï¸ è«‹æ‹æ”è™•æ–¹ç®‹ï¼");
    
    if (!name || !phone) return alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");

    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingText').innerText = "è³‡æ–™å‚³é€ä¸­...";

    const payload = {
      action: "upload",
      name: name, 
      lineName: lineDisplayName, 
      phone: phone,
      dept: dept || "ç¾å ´ç™»è¨˜", // è‹¥æ²’å¡«ç§‘åˆ¥ï¼Œé è¨­ç‚ºç¾å ´
      notify: notify,
      fileData: base64Image, // ç¾å ´æ¨¡å¼ä¸‹é€™æœƒæ˜¯ç©ºçš„
      fileName: fileName,
      lineUserId: lineUserId,
      isRegister: isRegisterMode // å‘Šè¨´å¾Œç«¯é€™æ˜¯ç´”ç™»è¨˜
    };

    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading').style.display = 'none';
      if(response.status === 'success') {
        alert("âœ… ç™»è¨˜æˆåŠŸï¼\nè—¥å¸«ç¢ºèªå¾Œæœƒç™¼é€é€šçŸ¥ã€‚");
        // å¦‚æœæ˜¯ç¾å ´ç™»è¨˜ï¼Œå¯ä»¥é¸æ“‡é—œé–‰è¦–çª—æˆ–é‡æ•´
        if(isRegisterMode) liff.closeWindow(); 
        else location.reload();
      } else {
        alert("âŒ å¤±æ•—ï¼š" + response.message);
      }
    })
    .catch(error => {
      document.getElementById('loading').style.display = 'none';
      alert("å‚³é€å®Œæˆã€‚");
      if(isRegisterMode) liff.closeWindow();
      else location.reload();
    });
  }
</script>

</body>
</html>
